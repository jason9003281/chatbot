# 배포 및 운영 가이드

이 문서는 `setup.sh`와 `deploy.sh` 스크립트를 사용한 서비스의 초기 설정 및 일반 배포 방법을 안내합니다.

---

## 1. 스크립트 개요

- **`/data/setup.sh`**: 최초 환경 구성 또는 전체 시스템을 초기화할 때 사용하는 스크립트입니다. 데이터베이스 볼륨을 포함한 모든 리소스를 제어합니다.
- **`/data/deploy.sh`**: 코드 변경 사항을 반영하는 등 일반적인 재배포 상황에서 사용합니다. 네트워크와 데이터베이스 데이터는 유지하면서 서비스를 안전하게 재시작합니다.

---

## 2. 최초 환경 구성

시스템을 처음 설정할 때 다음 순서대로 명령어를 실행합니다.

### 2.1. Python 가상 환경 설정 (필수)

Docker 외부에서 스크립트를 직접 실행하거나 테스트할 경우를 대비하여, 먼저 Python 가상 환경을 설정하고 의존성 패키지를 설치합니다.

```bash
# 1. 가상 환경 생성
python3 -m venv /data/env/venv

# 2. 의존성 패키지 설치
/data/env/venv/bin/python3 -m pip install -r /data/deploy/cmo-ai-be/requirements.txt
```

### 2.2. Docker 서비스 실행

가상 환경 설정 후, Docker 서비스를 시작합니다.

```bash
/data/setup.sh up
```

**실행 내용:**
- `docker-compose.yml`에 정의된 모든 서비스의 Docker 이미지를 빌드합니다.
- `postgres` 데이터베이스 컨테이너를 생성하고 시작합니다.
- `db-init` 서비스를 실행하여 **데이터베이스 테이블을 생성**하고 **기본 관리자/사용자 계정을 추가**합니다.
- `backend`와 `frontend` `redis` 서비스를 시작합니다.

> **주의:** 이 전체 과정은 시스템을 처음 구축할 때 한 번만 실행하면 됩니다.

---

## 3. 일반 재배포 (코드 변경 후)

백엔드 또는 프론트엔드 코드 변경 사항을 적용하려면 다음 명령어를 사용합니다.

```bash
/data/deploy.sh restart
```

**실행 내용:**
1.  `docker compose stop`을 실행하여 현재 실행 중인 서비스 컨테이너들을 **안전하게 중지**합니다. (네트워크와 볼륨은 유지)
2.  `docker compose up -d --build`를 실행하여 변경된 코드로 새로운 이미지를 빌드하고, 컨테이너를 다시 시작합니다.
3.  `db-init` 서비스는 실행되지 않으므로 기존 데이터는 그대로 보존됩니다.

---

## 4. 전체 시스템 초기화 (모든 데이터 삭제)

**경고: 이 명령어는 데이터베이스의 모든 데이터를 영구적으로 삭제합니다.**

개발 환경을 처음 상태로 되돌리거나, 시스템에 심각한 문제가 발생했을 때 사용합니다.

```bash
/data/setup.sh down
```

**실행 내용:**
- 모든 서비스 컨테이너를 중지하고 삭제합니다.
- Docker 네트워크를 삭제합니다.
- `postgres_data` 볼륨을 삭제하여 **모든 데이터베이스 데이터를 영구적으로 제거**합니다.

초기화 후에는 다시 ` /data/setup.sh up` 명령어를 실행하여 시스템을 새로 구성해야 합니다.

---

## 5. 서비스 상태 확인

언제든지 아래 명령어를 사용하여 현재 서비스들의 실행 상태를 확인할 수 있습니다.

```bash
# 일반 상태 확인
/data/deploy.sh status

# 또는
/data/setup.sh status
